# Map concatenation of request method + content-type to a blocking flag ($block_post)
# - Allow POST if Content-Type is one of:
#     - application/sparql-query (read-only queries)
#     - application/sparql-results
#     - application/x-www-form-urlencoded
#     - application/json
# - Block all other POST requests (e.g., sparql-update)
# - Default allow for other HTTP methods

map $request_method$http_content_type $block_post {
    default 0;
    "~^POSTapplication/sparql-query" 0;        
    "~^POSTapplication/sparql-results" 0;     
    "~^POSTapplication/x-www-form-urlencoded" 0; 
    "~^POSTapplication/json" 0;               
    "~^POST" 1;                               
}

server {
    listen 80;

    # Proxy SPARQL requests to backend qEndpoint service
    location /sparql {
        # Restrict allowed HTTP methods to GET, HEAD, POST; deny others like PUT, DELETE
        limit_except GET HEAD POST {
            deny all;
        }

        # For POST, deny if not allowed by $block_post map
        if ($block_post) {
            return 403;
        }

        # Forward requests to qendpoint Docker service on internal network
        proxy_pass http://qendpoint:1234/api/endpoint/sparql;

        # Preserve original Host header for backend routing/validation
        proxy_set_header Host $host;

        # Forward client IP, useful for backend logging/security
        proxy_set_header X-Real-IP $remote_addr;

        # Hide backend framework info from clients by removing X-Powered-By header
        proxy_hide_header X-Powered-By;
    }

    # Proxy static files (web UI)
    location / {
        # Allow only GET and HEAD for static content
        limit_except GET HEAD {
            deny all;
        }
        proxy_pass http://geonames-web:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_hide_header X-Powered-By;
    }
}