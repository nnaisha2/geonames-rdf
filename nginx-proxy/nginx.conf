# This creates a variable $block_post based on the method and Content-Type.
# - If the request is a POST with 'application/sparql-query' (read-only), allow it (value 0).
# - All other POSTs (e.g. 'application/sparql-update') are blocked (value 1).
# - GET and HEAD requests are allowed by default.

map $request_method$http_content_type $block_post {
    default 0;
    "~^POSTapplication/sparql-query" 0;        
    "~^POSTapplication/sparql-results" 0;     
    "~^POSTapplication/x-www-form-urlencoded" 0; 
    "~^POSTapplication/json" 0;               
    "~^POST" 1;                                # block everything else (e.g., sparql-update)
}

server {
    listen 80;

    # Proxy /sparql to qEndpoint
    location /sparql {
        # Only allow GET, HEAD, and POST methods. Deny everything else (e.g., PUT, DELETE).
        limit_except GET HEAD POST {
            deny all;
        }

        # Block POST requests unless they pass the $block_post rule above.
        if ($block_post) {
            return 403;
        }

        # Forward incoming requests to the backend SPARQL endpoint service
        # "qendpoint" is the Docker container hostname/service name within the Docker network
        # and "1234" is the internal port the service listens on.
        # This direct container-to-container communication bypasses host port mappings.
        proxy_pass http://qendpoint:1234/api/endpoint/sparql;

        # Forward the original Host header from the client to the backend
        # Important because backend services often use the Host header for routing or validation.
        proxy_set_header Host $host;

        # Send the client's real IP address to the backend via the X-Real-IP header
        # Without this, backend logs and security rules would only see the proxy's IP.
        proxy_set_header X-Real-IP $remote_addr;

        # Remove the X-Powered-By header added by some backend frameworks,
        # which helps avoid revealing sensitive backend implementation details to clients.
        proxy_hide_header X-Powered-By;
    }

    # Proxy static web UI
    location / {
        limit_except GET HEAD {
            deny all;
        }
        proxy_pass http://geonames-web:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_hide_header X-Powered-By;
    }
}